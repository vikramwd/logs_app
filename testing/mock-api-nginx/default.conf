include /etc/nginx/conf.d/mock-maps.conf;

log_format main_json escape=json '{'
  '"time":"$time_iso8601",'
  '"remote_addr":"$remote_addr",'
  '"host":"$host",'
  '"x_forwarded_for":"$http_x_forwarded_for",'
  '"method":"$request_method",'
  '"path":"$uri",'
  '"query":"$args",'
  '"request_uri":"$request_uri",'
  '"profile_id":"$arg_id",'
  '"mock_id":"$mock_id",'
  '"id":"$mock_id",'
  '"email":"$mock_email",'
  '"first_name":"$mock_first_name",'
  '"last_name":"$mock_last_name",'
  '"name":"$mock_name",'
  '"gender":"$mock_gender",'
  '"ip_address":"$mock_ip_address",'
  '"phone":"$mock_phone",'
  '"city":"$mock_city",'
  '"birthday_month":"$mock_birthday_month",'
  '"age":"$mock_age",'
  '"address":"$mock_address",'
  '"digital_id":"$mock_digital_id",'
  '"education":"$mock_education",'
  '"marital_status":"$mock_marital_status",'
  '"employment_status":"$mock_employment_status",'
  '"blood_group":"$mock_blood_group",'
  '"country":"$mock_country",'
  '"state":"$mock_state",'
  '"postal_code":"$mock_postal_code",'
  '"health_id":"$mock_health_id",'
  '"status":$status,'
  '"request_length":$request_length,'
  '"body_bytes_sent":$body_bytes_sent,'
  '"request_time":$request_time,'
  '"upstream_response_time":"$upstream_response_time",'
  '"referer":"$http_referer",'
  '"user_agent":"$http_user_agent"'
'}';

split_clients "$request_id" $random_profile_id {
  1% 1;
  1% 2;
  1% 3;
  1% 4;
  1% 5;
  1% 6;
  1% 7;
  1% 8;
  1% 9;
  1% 10;
  1% 11;
  1% 12;
  1% 13;
  1% 14;
  1% 15;
  1% 16;
  1% 17;
  1% 18;
  1% 19;
  1% 20;
  1% 21;
  1% 22;
  1% 23;
  1% 24;
  1% 25;
  1% 26;
  1% 27;
  1% 28;
  1% 29;
  1% 30;
  1% 31;
  1% 32;
  1% 33;
  1% 34;
  1% 35;
  1% 36;
  1% 37;
  1% 38;
  1% 39;
  1% 40;
  1% 41;
  1% 42;
  1% 43;
  1% 44;
  1% 45;
  1% 46;
  1% 47;
  1% 48;
  1% 49;
  1% 50;
  1% 51;
  1% 52;
  1% 53;
  1% 54;
  1% 55;
  1% 56;
  1% 57;
  1% 58;
  1% 59;
  1% 60;
  1% 61;
  1% 62;
  1% 63;
  1% 64;
  1% 65;
  1% 66;
  1% 67;
  1% 68;
  1% 69;
  1% 70;
  1% 71;
  1% 72;
  1% 73;
  1% 74;
  1% 75;
  1% 76;
  1% 77;
  1% 78;
  1% 79;
  1% 80;
  1% 81;
  1% 82;
  1% 83;
  1% 84;
  1% 85;
  1% 86;
  1% 87;
  1% 88;
  1% 89;
  1% 90;
  1% 91;
  1% 92;
  1% 93;
  1% 94;
  1% 95;
  1% 96;
  1% 97;
  1% 98;
  1% 99;
  1% 100;
}


server {
  listen 80;
  server_name _;
  root /usr/share/nginx/html;

  access_log /var/log/nginx/access.log main_json;

  location = /api/profile {
    default_type application/json;
    add_header Cache-Control "no-store";
    set $profile_id $arg_id;
    if ($profile_id = "") { set $profile_id $msec; }
    if ($profile_id ~ "([0-9]{2})$") { set $profile_id $1; }
    if ($profile_id = "00") { set $profile_id 100; }
    if ($profile_id ~ "^0([0-9])$") { set $profile_id $1; }
    rewrite ^ /profiles/$profile_id.json break;
    try_files $uri =404;
  }

  location = /api/mock-data {
    default_type application/yaml;
    add_header Cache-Control "no-store";
    set $mock_id $arg_id;
    if ($mock_id = "") { set $mock_id $msec; }
    if ($mock_id ~ "([0-9]{2})$") { set $mock_id $1; }
    if ($mock_id = "00") { set $mock_id 100; }
    if ($mock_id ~ "^0([0-9])$") { set $mock_id $1; }
    rewrite ^ /mock-data/$mock_id.yaml break;
    try_files $uri =404;
  }

  location /profiles/ {
    default_type application/json;
    try_files $uri =404;
  }

  location / {
    return 404;
  }
}
