{{- if .Values.envSecrets.enabled }}
{{- $raw := .Files.Get .Values.envConfig.envFile | default "" }}
{{- $lines := splitList "\n" $raw }}
{{- $secretKeys := dict }}
{{- range $k := .Values.envSecrets.keys }}
{{- $_ := set $secretKeys (upper $k) true }}
{{- end }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.envSecrets.name | quote }}
  namespace: {{ .Values.namespace.name | quote }}
  labels:
    app: {{ include "logsearch.name" . }}
type: Opaque
stringData:
  {{- range $line := $lines }}
  {{- $trim := trim $line }}
  {{- if and $trim (not (hasPrefix $trim "#")) (contains "=" $trim) }}
  {{- $parts := splitList "=" $trim }}
  {{- $key := trim (index $parts 0) }}
  {{- $valRaw := trim (join "=" (slice $parts 1)) }}
  {{- $valParts := splitList "#" $valRaw }}
  {{- $val := trim (index $valParts 0) }}
  {{- if and $key (hasKey $secretKeys (upper $key)) }}
  {{ $key }}: {{ $val | quote }}
  {{- end }}
  {{- end }}
  {{- end }}
{{- end }}
